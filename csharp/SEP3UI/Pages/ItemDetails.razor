@page "/ItemDetails/{id:int}"
@using SEP3UI.Data
@using System.Security.Claims
@using SEP3Library.Models
@using SEP3UI.Authentication
@inject IItemService itemService
@inject IOrderService orderService
@inject ICustomerService customerService
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navigationManager

@if (item == null) {
    <h2>Loading</h2>
}
else {
    <div class="container">
        <div class="card row ">
            <div class="row border-top border-bottom">
                <div class="col-md-6">
                    <div class="img-responsive m-3 text-center mt-5">
                        <img src="@item.ImageName"/>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="pt-5 pl-5">
                        <AuthorizeView>
                            <div class="text-right">
                                @if (favorite) {
                                    <i class="favorite oi oi-heart mr-5" @onclick="PerformUnfavoriteAsync"></i>
                                }
                                else {
                                    <i class="notfavorite oi oi-heart mr-5" @onclick="PerformFavoriteAsync"></i>
                                }
                            </div>
                        </AuthorizeView>
                        <h2 class="mb-4">
                            <div class="retroshd">@item.Name</div>
                        </h2>
                        <div>
                            <b>About:</b> @item.Description
                        </div>
                        <div class="mt-2">
                            <span>
                                <strong>Category:</strong>
                                <a rel="tag" href="#">@item.Category.Name</a>
                            </span>
                        </div>
                        @if (item.Category.Name.Equals("Book") && book != null) {
                            <div class="mt-2">
                                <span>
                                    <strong>Author:</strong>
                                    @foreach (Author author in book.Authors) {
                                        <a rel="tag" href="#">@author.FirstName @author.LastName</a>
                                    }
                                </span>
                            </div>
                            <div class="mt-2">
                                <span>
                                    <strong>Publication Date: </strong>@book.PublicationDate
                                </span>
                            </div>
                            <div class="mt-2">
                                <span>
                                    <strong>Language: </strong>
                                    <a rel="tag" href="#">@book.Language</a>
                                </span>
                            </div>
                            <div class="mt-2">
                                <span>
                                    <strong>Genre: </strong>
                                    @foreach (Genre g in book.Genre) {
                                        <a rel="tag" href="#">@g.Name</a>
                                    }
                                </span>
                            </div>
                        }
                        <div class="mt-2">
                            <strong>Price: </strong> <span class="amount-old">@Math.Round(item.Price, 2, MidpointRounding.ToEven) DKK</span>
                            @if (item.Discount > 0) {
                                <span class="ml-2 text-danger">(@item.Discount% OFF)</span>
                            }
                        </div>
                        <div class="form-group mt-2">
                            <label>
                                <strong>Quantity: </strong> @item.Quantity
                            </label>
                        </div>
                        <div class="form-group mt-2">
                            <label>
                                <strong>Status: </strong>
                            </label>
                            @if (item.Quantity == 0) {
                                <span class="text-danger"> Out of stock.</span>
                            } else {
                                <span class="text-success"> In stock.</span>
                            }
                        </div>
                        <div class="mt-5">
                            <button class="btn btn-round btn-dark" disabled="@isDisabled" @onclick="(() => AddToShoppingCart(item))">
                                <i class="fa fa-shopping-cart"></i> Add to Shopping Cart
                            </button>
                            <AuthorizeView Policy="@Policies.IsAdmin">
                                <button class="btn btn-round btn-dark" disabled="@isDisabled" @onclick="(() => View(item.Id, item.Category.Name))">
                                    <i class="fa fa-shopping-cart"></i> Edit Item
                                </button>
                            </AuthorizeView>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private int customerId;
    private Item item;
    private Book book;
    private bool isDisabled;
    private bool favorite = true;

    protected override async Task OnInitializedAsync() {
        item = await itemService.GetItemAsync(Id);
        if (item.Category.Name.Equals("Book")) {
            book = await itemService.GetBookAsync(Id);
        }

        SetDisabledState();
        try {
            customerId = int.Parse((await authStateProvider.GetAuthenticationStateAsync()).User.FindFirstValue("Id"));
        } catch (Exception e) {
            customerId = -1;
        }

        if (customerId != -1) {
            IList<Item> wishlist = await customerService.GetCustomerWishlistAsync(customerId);
            favorite = wishlist.FirstOrDefault(i => i.Id == item.Id) != null;
        }
    }

    private void SetDisabledState() {
        if (item.Quantity < 1) {
            item.Status = ItemStatus.OutOfStock;
            isDisabled = true;
        }
    }

    private async Task AddToShoppingCart(Item itemToAdd) {
        Item i = orderService.ShoppingCart.AddToShoppingCart(itemToAdd);
        if (customerId != -1)
            await customerService.AddToShoppingCartAsync(i, customerId);
    }
    
    private void View(int id, String categoryName) {
        navigationManager.NavigateTo($"EditItem/{id}/{categoryName}");
    }

    private async Task PerformUnfavoriteAsync() {
        favorite = false;
        await customerService.RemoveWishlistedItem(customerId, item.Id);
    }

    private async Task PerformFavoriteAsync() {
        favorite = true;
        await customerService.AddToWishlistAsync(customerId, item);
    }
}